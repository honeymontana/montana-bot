# Montana Helper Bot

Telegram бот для автоматического управления доступом к чатам на основе подписки в основной группе Montana.

## Функциональность

- ✅ Автоматическая проверка членства в основной группе Montana
- ✅ Автоматическое одобрение заявок на вступление при наличии активной подписки
- ✅ Автоматическое удаление пользователей из всех чатов при выходе из Montana
- ✅ Уведомления пользователям об удалении из-за окончания подписки
- ✅ Динамическое управление списком управляемых чатов
- ✅ Ограничение времени доступа для вступления в группы
- ✅ Полное логирование всех действий
- ✅ Docker контейнеризация с автоперезапуском
- ✅ PostgreSQL база данных для хранения состояния
- ✅ Покрытие тестами основных компонентов

## Требования

- Node.js 20+
- Docker и Docker Compose
- PostgreSQL 16+ (или использование Docker)
- Telegram Bot Token

## Быстрый старт

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd montana-tg-bot
```

### 2. Установка зависимостей

```bash
npm install
```

### 3. Настройка окружения

Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

Отредактируйте `.env` файл:

```env
# Bot Configuration
BOT_TOKEN=your_bot_token_here
NODE_ENV=production

# Database Configuration
DB_HOST=postgres
DB_PORT=5432
DB_NAME=montana_bot
DB_USER=montana
DB_PASSWORD=secure_password_here

# Telegram Groups
MAIN_GROUP_ID=-1001234567890  # ID основной группы Montana

# Bot Settings
CHECK_INTERVAL_MINUTES=5
LOG_LEVEL=info
TEST_MODE=true  # Тестовый режим - бот НЕ удаляет пользователей, только показывает список

# Admin Users (Telegram user IDs)
ADMIN_IDS=123456789,987654321
```

### 4. Создание бота в Telegram

1. Откройте [@BotFather](https://t.me/botfather)
2. Создайте нового бота: `/newbot`
3. Получите токен и добавьте его в `.env`
4. Добавьте бота администратором во все группы

### 5. Запуск с Docker

```bash
# Запуск в production
docker-compose up -d

# Просмотр логов
docker-compose logs -f bot

# Остановка
docker-compose down
```

### 6. Запуск для разработки

```bash
# Запустить только базу данных
docker-compose -f docker-compose.dev.yml up -d

# Запустить бота в dev режиме
npm run dev
```

## Как это работает

1. **Размещение ссылки с доступом по заявке** - Вы создаете ссылку на группу с режимом "Требуется одобрение администратора"
2. **Автоматическая обработка заявок** - Бот автоматически проверяет наличие подписки в Montana
3. **Одобрение/Отклонение** - Есть подписка → автоматически одобряется, нет подписки → отклоняется
4. **Автоматическое удаление** - При выходе из Montana пользователь автоматически удаляется из всех управляемых чатов с уведомлением

## Команды бота

### Пользовательские команды

- `/start` - Начать работу с ботом
- `/status` - Проверить статус подписки

### Админ команды

- `/sync` - Синхронизировать членство вручную
- `/checkremoval` - Проверить список пользователей для удаления (тестовый режим)
- `/addgroup [chat_id] [hours]` - Добавить группу в управление
- `/updategroup <chat_id> [hours|unlimited]` - Обновить окно доступа группы
- `/removegroup <group_id>` - Деактивировать группу
- `/syncgroup` - Синхронизировать администраторов группы
- `/fullsync` - Полная синхронизация ВСЕХ участников (MTProto API)

## Тестовый режим

Перед запуском бота в продакшн рекомендуется протестировать его работу:

1. **Включите тестовый режим** в `.env`:
   ```env
   TEST_MODE=true
   ```

2. **Запустите бота** и используйте команду `/checkremoval` или `/sync`

3. **Проверьте список** пользователей, которые будут удалены:
   - Бот покажет кто будет удален и из каких групп
   - В тестовом режиме **никто не удаляется**
   - Периодическая синхронизация отправляет отчеты админам

4. **После проверки** переключите на продакшн режим:
   ```env
   TEST_MODE=false
   ```

5. **Перезапустите бота** - теперь он будет реально удалять пользователей

## Управление окном доступа к группам

Бот поддерживает ограничение времени для вступления в управляемые группы:

### Добавление группы с ограничением времени

- `/addgroup -1001234567890` - добавить группу без ограничения по времени (доступ всегда открыт)
- `/addgroup -1001234567890 48` - добавить группу с окном доступа 48 часов с момента добавления

### Обновление окна доступа

- `/updategroup -1001234567890 unlimited` - убрать ограничение по времени
- `/updategroup -1001234567890 72` - установить новое окно доступа 72 часа с текущего момента

### Как это работает

1. **Без ограничения** - Пользователи могут подавать заявки в любое время
2. **С ограничением** - Пользователи могут вступить только в течение указанного времени с момента добавления/обновления группы
3. **Закрытое окно** - Если окно истекло, новые заявки будут отклоняться с сообщением об истечении времени

### Примеры использования

**Группа без ограничений**:
- Основные чаты сообщества
- Постоянный доступ для всех подписчиков

**Группа с временным окном**:
- Марафоны и challenge-группы
- Ограниченные по времени предложения
- Сезонный контент

## Архитектура

```
montana-tg-bot/
├── src/
│   ├── bot/              # Основная логика бота
│   │   └── MontanaBot.ts  # Главный класс бота
│   ├── config/            # Конфигурация
│   │   └── index.ts       # Загрузка и валидация config
│   ├── database/          # База данных
│   │   └── connection.ts  # PostgreSQL соединение
│   ├── repositories/      # Репозитории для работы с БД
│   │   ├── UserRepository.ts
│   │   └── GroupRepository.ts
│   ├── services/          # Бизнес-логика
│   │   └── MembershipService.ts
│   ├── types/             # TypeScript типы
│   │   └── index.ts
│   ├── utils/             # Утилиты
│   │   └── logger.ts      # Winston логгер
│   └── index.ts           # Точка входа
├── __tests__/             # Тесты
├── logs/                  # Логи (создается автоматически)
├── docker-compose.yml     # Production конфигурация
├── Dockerfile             # Docker образ
└── init-db.sql            # Инициализация БД
```

## База данных

### Основные таблицы

- `users` - Пользователи Telegram
- `groups` - Управляемые группы
- `user_groups` - Членство пользователей в группах
- `join_requests` - История заявок на вступление
- `activity_logs` - Логи действий
- `bot_settings` - Настройки бота

## Тестирование

```bash
# Запуск всех тестов
npm test

# Запуск с покрытием
npm run test:coverage

# Запуск в watch режиме
npm run test:watch
```

## Мониторинг

### Просмотр логов

```bash
# Docker логи
docker-compose logs -f bot

# Файловые логи
tail -f logs/combined.log
tail -f logs/error.log
```

### Проверка состояния

```bash
# Статус контейнеров
docker-compose ps

# Здоровье базы данных
docker-compose exec postgres pg_isready
```

## Безопасность

1. **Никогда не коммитьте `.env` файл**
2. Используйте сложные пароли для базы данных
3. Ограничьте доступ к админ командам через `ADMIN_IDS`
4. Регулярно обновляйте зависимости: `npm audit fix`
5. Используйте HTTPS для webhook в production

## Деплой

### Рекомендации для production

1. Используйте отдельный сервер или VPS
2. Настройте автоматический бэкап базы данных
3. Используйте систему мониторинга (Prometheus/Grafana)
4. Настройте логротацию для файлов логов
5. Используйте reverse proxy (nginx) для webhook

### Пример systemd сервиса

```ini
[Unit]
Description=Montana Telegram Bot
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/montana-bot
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
ExecReload=/usr/local/bin/docker-compose restart

[Install]
WantedBy=multi-user.target
```

## Решение проблем

### Бот не отвечает

1. Проверьте токен в `.env`
2. Проверьте логи: `docker-compose logs bot`
3. Убедитесь что бот добавлен в группы как админ

### Ошибки базы данных

1. Проверьте подключение: `docker-compose exec postgres psql -U montana -d montana_bot`
2. Проверьте миграции: `docker-compose exec bot npm run migration:run`
3. Пересоздайте БД при необходимости

### Пользователи не удаляются из групп

1. Проверьте права бота в группах (должен быть админом)
2. Проверьте ID основной группы в `.env`
3. Запустите ручную синхронизацию: `/sync`

## Поддержка

При возникновении проблем:

1. Проверьте логи
2. Проверьте конфигурацию
3. Убедитесь что все сервисы запущены
4. Создайте issue в репозитории

## Лицензия

ISC

## Авторы

Montana Development Team