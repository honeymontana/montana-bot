# Montana Helper Bot

Telegram бот для управления доступом к дополнительным чатам на основе подписки в основной группе Montana.

## Функциональность

- ✅ Автоматическая проверка членства в основной группе
- ✅ Автоматическое одобрение заявок на вступление в дополнительные чаты
- ✅ Удаление пользователей из всех чатов при отписке от основной группы
- ✅ Динамическое управление списком доступных чатов
- ✅ Поддержка постоянных групп с пожизненным доступом
- ✅ Полное логирование всех действий
- ✅ Docker контейнеризация с автоперезапуском
- ✅ PostgreSQL база данных для хранения состояния
- ✅ Покрытие тестами основных компонентов

## Требования

- Node.js 20+
- Docker и Docker Compose
- PostgreSQL 16+ (или использование Docker)
- Telegram Bot Token

## Быстрый старт

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd montana-tg-bot
```

### 2. Установка зависимостей

```bash
npm install
```

### 3. Настройка окружения

Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

Отредактируйте `.env` файл:

```env
# Bot Configuration
BOT_TOKEN=your_bot_token_here
NODE_ENV=production

# Database Configuration
DB_HOST=postgres
DB_PORT=5432
DB_NAME=montana_bot
DB_USER=montana
DB_PASSWORD=secure_password_here

# Telegram Groups
MAIN_GROUP_ID=-1001234567890  # ID основной группы Montana

# Bot Settings
CHECK_INTERVAL_MINUTES=5
LOG_LEVEL=info
TEST_MODE=true  # Тестовый режим - бот НЕ удаляет пользователей, только показывает список

# Admin Users (Telegram user IDs)
ADMIN_IDS=123456789,987654321
```

### 4. Создание бота в Telegram

1. Откройте [@BotFather](https://t.me/botfather)
2. Создайте нового бота: `/newbot`
3. Получите токен и добавьте его в `.env`
4. Добавьте бота администратором во все группы

### 5. Запуск с Docker

```bash
# Запуск в production
docker-compose up -d

# Просмотр логов
docker-compose logs -f bot

# Остановка
docker-compose down
```

### 6. Запуск для разработки

```bash
# Запустить только базу данных
docker-compose -f docker-compose.dev.yml up -d

# Запустить бота в dev режиме
npm run dev
```

## Команды бота

### Пользовательские команды

- `/start` - Начать работу с ботом
- `/groups` - Показать доступные группы
- `/status` - Проверить ваш статус
- `/help` - Показать справку

### Админ команды

- `/sync` - Синхронизировать членство вручную
- `/checkremoval` - Проверить список пользователей для удаления (тестовый режим)
- `/addgroup` - Добавить текущую группу в управление (использовать в группе)
- `/addpermanentgroup` - Добавить текущую группу как постоянную с пожизненным доступом
- `/removegroup <group_id>` - Деактивировать группу
- `/syncgroup` - Синхронизировать администраторов группы
- `/fullsync` - Полная синхронизация ВСЕХ участников (MTProto API)

## Тестовый режим

Перед запуском бота в продакшн рекомендуется протестировать его работу:

1. **Включите тестовый режим** в `.env`:
   ```env
   TEST_MODE=true
   ```

2. **Запустите бота** и используйте команду `/checkremoval` или `/sync`

3. **Проверьте список** пользователей, которые будут удалены:
   - Бот покажет кто будет удален и из каких групп
   - В тестовом режиме **никто не удаляется**
   - Периодическая синхронизация отправляет отчеты админам

4. **После проверки** переключите на продакшн режим:
   ```env
   TEST_MODE=false
   ```

5. **Перезапустите бота** - теперь он будет реально удалять пользователей

## Постоянные группы (Permanent Groups)

Бот поддерживает два типа управляемых групп:

### 1. Обычные группы (добавляются через `/addgroup`)

- **Членство привязано к основной группе Montana**
- При выходе из Montana пользователь автоматически удаляется из всех обычных групп
- Подходит для контента, доступ к которому зависит от активной подписки

### 2. Постоянные группы (добавляются через `/addpermanentgroup`)

- **Пожизненный доступ** - пользователь остается в группе навсегда
- Проверка членства в Montana происходит **только при первом входе**
- Даже если пользователь выйдет из Montana, он **не будет удален** из постоянных групп
- Подходит для эксклюзивного контента, курсов, закрытых сообществ

### Как использовать постоянные группы

1. Добавьте бота администратором в группу, которую хотите сделать постоянной
2. Напишите в этой группе команду `/addpermanentgroup`
3. Бот подтвердит добавление группы с пометкой "ПОСТОЯННАЯ"
4. Теперь пользователи будут:
   - Проверяться на членство в Montana при первом входе
   - Получать доступ навсегда после одобрения
   - Оставаться в группе даже после выхода из Montana

### Примеры использования

**Обычная группа** (`/addgroup`):
- Ежемесячный контент для подписчиков
- Каналы с регулярными обновлениями
- Чаты поддержки для активных клиентов

**Постоянная группа** (`/addpermanentgroup`):
- Закрытый курс, купленный один раз
- VIP-сообщество для инвесторов
- Эксклюзивный архив материалов

## Архитектура

```
montana-tg-bot/
├── src/
│   ├── bot/              # Основная логика бота
│   │   └── MontanaBot.ts  # Главный класс бота
│   ├── config/            # Конфигурация
│   │   └── index.ts       # Загрузка и валидация config
│   ├── database/          # База данных
│   │   └── connection.ts  # PostgreSQL соединение
│   ├── repositories/      # Репозитории для работы с БД
│   │   ├── UserRepository.ts
│   │   └── GroupRepository.ts
│   ├── services/          # Бизнес-логика
│   │   └── MembershipService.ts
│   ├── types/             # TypeScript типы
│   │   └── index.ts
│   ├── utils/             # Утилиты
│   │   └── logger.ts      # Winston логгер
│   └── index.ts           # Точка входа
├── __tests__/             # Тесты
├── logs/                  # Логи (создается автоматически)
├── docker-compose.yml     # Production конфигурация
├── Dockerfile             # Docker образ
└── init-db.sql            # Инициализация БД
```

## База данных

### Основные таблицы

- `users` - Пользователи Telegram
- `groups` - Управляемые группы
- `user_groups` - Членство пользователей в группах
- `join_requests` - История заявок на вступление
- `activity_logs` - Логи действий
- `bot_settings` - Настройки бота

## Тестирование

```bash
# Запуск всех тестов
npm test

# Запуск с покрытием
npm run test:coverage

# Запуск в watch режиме
npm run test:watch
```

## Мониторинг

### Просмотр логов

```bash
# Docker логи
docker-compose logs -f bot

# Файловые логи
tail -f logs/combined.log
tail -f logs/error.log
```

### Проверка состояния

```bash
# Статус контейнеров
docker-compose ps

# Здоровье базы данных
docker-compose exec postgres pg_isready
```

## Безопасность

1. **Никогда не коммитьте `.env` файл**
2. Используйте сложные пароли для базы данных
3. Ограничьте доступ к админ командам через `ADMIN_IDS`
4. Регулярно обновляйте зависимости: `npm audit fix`
5. Используйте HTTPS для webhook в production

## Деплой

### Рекомендации для production

1. Используйте отдельный сервер или VPS
2. Настройте автоматический бэкап базы данных
3. Используйте систему мониторинга (Prometheus/Grafana)
4. Настройте логротацию для файлов логов
5. Используйте reverse proxy (nginx) для webhook

### Пример systemd сервиса

```ini
[Unit]
Description=Montana Telegram Bot
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/montana-bot
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
ExecReload=/usr/local/bin/docker-compose restart

[Install]
WantedBy=multi-user.target
```

## Решение проблем

### Бот не отвечает

1. Проверьте токен в `.env`
2. Проверьте логи: `docker-compose logs bot`
3. Убедитесь что бот добавлен в группы как админ

### Ошибки базы данных

1. Проверьте подключение: `docker-compose exec postgres psql -U montana -d montana_bot`
2. Проверьте миграции: `docker-compose exec bot npm run migration:run`
3. Пересоздайте БД при необходимости

### Пользователи не удаляются из групп

1. Проверьте права бота в группах (должен быть админом)
2. Проверьте ID основной группы в `.env`
3. Запустите ручную синхронизацию: `/sync`

## Поддержка

При возникновении проблем:

1. Проверьте логи
2. Проверьте конфигурацию
3. Убедитесь что все сервисы запущены
4. Создайте issue в репозитории

## Лицензия

ISC

## Авторы

Montana Development Team