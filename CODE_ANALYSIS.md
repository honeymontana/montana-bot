# üîç Montana Bot - –ê–Ω–∞–ª–∏–∑ –ö–æ–¥–æ–≤–æ–π –ë–∞–∑—ã

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 12 —Ñ–µ–≤—Ä–∞–ª—è 2026
**–í–µ—Ä—Å–∏—è:** 1.0.0
**–ê–Ω–∞–ª–∏—Ç–∏–∫:** Claude Code

---

## üìä –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚úÖ

1. **–ß—ë—Ç–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: Separation of Concerns (Repositories, Services, Bot logic)
2. **TypeScript**: –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
3. **–•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞**: –õ–æ–≥–∏—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –º–æ–¥—É–ª–∏
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ù–∞–ª–∏—á–∏–µ Jest —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: Winston –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤
6. **Docker**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –¥–µ–ø–ª–æ—è
7. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î**: –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
8. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: Joi –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
9. **Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: OAuth 2.0 –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–æ–ª–µ–π
10. **Dashboard**: –í–µ–±-–¥–∞—à–±–æ—Ä–¥ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã üî¥

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ error handling –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö**
2. **–ù–µ—Ç rate limiting –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤**
3. **Memory leaks —Ä–∏—Å–∫**: –ù–µ—Ç –æ—á–∏—Å—Ç–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ graceful shutdown**
5. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ë–î –∑–∞–ø—Ä–æ—Å—ã**: N+1 queries –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö
6. **–°–µ–∫—Ä–µ—Ç—ã –≤ –ª–æ–≥–∞—Ö**: –¢–æ–∫–µ–Ω—ã –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å –≤ –ª–æ–≥ —Ñ–∞–π–ª—ã
7. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞**: –ü–æ—Ö–æ–∂–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
src/
‚îú‚îÄ‚îÄ bot/              # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –±–æ—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ MontanaBot.ts
‚îú‚îÄ‚îÄ services/         # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ MembershipService.ts      # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–ª–µ–Ω—Å—Ç–≤–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ TelegramClientService.ts  # MTProto API
‚îÇ   ‚îú‚îÄ‚îÄ DiscordService.ts         # Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ DiscordOAuthServer.ts     # OAuth —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îî‚îÄ‚îÄ TributeService.ts         # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
‚îú‚îÄ‚îÄ repositories/     # Data access layer
‚îÇ   ‚îú‚îÄ‚îÄ UserRepository.ts
‚îÇ   ‚îú‚îÄ‚îÄ GroupRepository.ts
‚îÇ   ‚îî‚îÄ‚îÄ DiscordRepository.ts
‚îú‚îÄ‚îÄ api/              # API endpoints
‚îÇ   ‚îî‚îÄ‚îÄ DashboardAPI.ts
‚îú‚îÄ‚îÄ database/         # DB connection & migrations
‚îú‚îÄ‚îÄ utils/            # –£—Ç–∏–ª–∏—Ç—ã (logger)
‚îî‚îÄ‚îÄ config/           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

**–û—Ü–µ–Ω–∫–∞:** ‚≠ê‚≠ê‚≠ê‚≠ê (4/5) - –•–æ—Ä–æ—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –Ω–æ –µ—Å—Ç—å –º–µ—Å—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

---

## üêõ –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Error Handling (–ö—Ä–∏—Ç–∏—á–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// MontanaBot.ts:394
const chat = await this.bot.getChat(targetChatId);
// –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –∫—Ä–∞—à
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
try {
  const chat = await this.bot.getChat(targetChatId);
} catch (error) {
  if (error.response?.statusCode === 400) {
    await this.bot.sendMessage(chatId, '‚ùå –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –±–æ—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –Ω–µ—ë.');
    return;
  }
  throw error;
}
```

**–õ–æ–∫–∞—Ü–∏—è:** `/src/bot/MontanaBot.ts:393-417`

---

### 2. Memory Leaks (–ö—Ä–∏—Ç–∏—á–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// MontanaBot.ts:801-828
this.syncInterval = setInterval(async () => {
  // –ï—Å–ª–∏ —Ç—É—Ç exception - interval –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
}, intervalMs);
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
private startPeriodicSync(): void {
  const runSync = async () => {
    try {
      await this.membershipService.syncMemberships();
    } catch (error) {
      log.error('Periodic sync failed', error);
      // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç –∞–¥–º–∏–Ω–∞–º
    }
  };

  this.syncInterval = setInterval(runSync, intervalMs);
  runSync(); // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
}
```

**–õ–æ–∫–∞—Ü–∏—è:** `/src/bot/MontanaBot.ts:801-828`

---

### 3. Graceful Shutdown (–ö—Ä–∏—Ç–∏—á–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ë–æ—Ç –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (SIGTERM, SIGINT)

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// src/index.ts
async function gracefulShutdown(signal: string) {
  log.info(`${signal} received, starting graceful shutdown...`);

  try {
    await bot.stop();
    await database.close();
    log.info('Graceful shutdown completed');
    process.exit(0);
  } catch (error) {
    log.error('Error during shutdown', error);
    process.exit(1);
  }
}

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));
```

**–õ–æ–∫–∞—Ü–∏—è:** `/src/index.ts` (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)

---

### 4. N+1 Query Problem (–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// MembershipService.ts:84
const userGroups = await this.userRepo.getUserGroups(userId);
// –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –¥–µ–ª–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å JOIN
SELECT
  ug.*,
  g.title,
  g.chat_id,
  g.is_main_group
FROM user_groups ug
JOIN groups g ON ug.group_id = g.id
WHERE ug.user_id = $1 AND ug.status IN ('member', 'administrator', 'creator')
```

**–õ–æ–∫–∞—Ü–∏—è:** `/src/repositories/UserRepository.ts`

---

### 5. Rate Limiting (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

**–ü—Ä–æ–±–ª–µ–º–∞:**
API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–∞—à–±–æ—Ä–¥–∞ –Ω–µ –∏–º–µ—é—Ç rate limiting - –≤–æ–∑–º–æ–∂–µ–Ω DDoS

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
import rateLimit from 'express-rate-limit';

const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  max: 100, // –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø—Ä–æ—Å–æ–≤
  message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ'
});

app.use('/api/', apiLimiter);
```

**–õ–æ–∫–∞—Ü–∏—è:** `/src/api/DashboardAPI.ts`

---

### 6. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (Code Quality)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 10+ –º–µ—Å—Ç–∞—Ö:

```typescript
if (!userId || !this.isAdmin(userId)) {
  await this.bot.sendMessage(chatId, '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤...');
  return;
}
```

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏–ª–∏ middleware:

```typescript
// utils/decorators.ts
function AdminOnly() {
  return function (
    target: any,
    propertyKey: string,
    descriptor: PropertyDescriptor
  ) {
    const originalMethod = descriptor.value;

    descriptor.value = async function(msg: TelegramBot.Message, ...args: any[]) {
      const userId = msg.from?.id;
      const chatId = msg.chat.id;

      if (!userId || !this.isAdmin(userId)) {
        await this.bot.sendMessage(chatId, '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
        return;
      }

      return originalMethod.apply(this, [msg, ...args]);
    };

    return descriptor;
  };
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
@AdminOnly()
private async handleSync(msg: TelegramBot.Message): Promise<void> {
  // –ö–æ–¥ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞
}
```

**–õ–æ–∫–∞—Ü–∏—è:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

---

### 7. –°–µ–∫—Ä–µ—Ç—ã –≤ –ª–æ–≥–∞—Ö (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// config/index.ts:50
console.log('üîë Loaded BOT_TOKEN:', envVars.BOT_TOKEN.substring(0, 25) + '...');
```

**–†–∏—Å–∫:** –¢–æ–∫–µ–Ω –º–æ–∂–µ—Ç –ø–æ–ø–∞—Å—Ç—å –≤ CI/CD –ª–æ–≥–∏, monitoring —Å–∏—Å—Ç–µ–º—ã

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –£–±—Ä–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ production
if (envVars.NODE_ENV !== 'production') {
  console.log('üîë Loaded BOT_TOKEN:', envVars.BOT_TOKEN.substring(0, 10) + '***');
}
```

**–õ–æ–∫–∞—Ü–∏—è:** `/src/config/index.ts:50`

---

### 8. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// MontanaBot.ts:969
const discordId = discordUserId.trim();
if (!/^\d{17,20}$/.test(discordId)) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –µ—Å—Ç—å, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
}
```

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤–≤–æ–¥–æ–≤:

```typescript
import { z } from 'zod';

const DiscordIdSchema = z.string()
  .regex(/^\d{17,20}$/, 'Invalid Discord ID format')
  .transform(id => id.trim());

const discordId = DiscordIdSchema.parse(discordUserId);
```

**–õ–æ–∫–∞—Ü–∏—è:** –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥

---

### 9. Telegram API Rate Limits (Reliability)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ rate limit –æ—à–∏–±–æ–∫ –æ—Ç Telegram API (429 Too Many Requests)

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
async function withRetry<T>(
  fn: () => Promise<T>,
  maxRetries = 3,
  delay = 1000
): Promise<T> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (error.response?.statusCode === 429) {
        const retryAfter = error.response.parameters?.retry_after || delay / 1000;
        log.warn(`Rate limited, retrying after ${retryAfter}s...`);
        await sleep(retryAfter * 1000);
        continue;
      }
      throw error;
    }
  }
  throw new Error('Max retries exceeded');
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
await withRetry(() => this.bot.sendMessage(chatId, text));
```

**–õ–æ–∫–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å `/src/utils/telegram.ts`

---

### 10. Database Connection Pool (–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// database/connection.ts
max: 20, // –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ –±–æ—Ç–∞
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
const config = {
  max: process.env.NODE_ENV === 'production' ? 10 : 5,
  min: 2, // –ú–∏–Ω–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
  // –î–æ–±–∞–≤–∏—Ç—å:
  allowExitOnIdle: false, // –ù–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å pool –ø—Ä–∏ idle
  maxUses: 7500, // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ N –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
};
```

**–õ–æ–∫–∞—Ü–∏—è:** `/src/config/index.ts:70`

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ - —Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å)

1. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å graceful shutdown**
2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–∏—Ç—å memory leaks –≤ intervals**
3. ‚úÖ **–£–ª—É—á—à–∏—Ç—å error handling**
4. ‚úÖ **–£–±—Ä–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤**
5. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è API**

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ - —Å–¥–µ–ª–∞—Ç—å –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ)

6. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î –∑–∞–ø—Ä–æ—Å—ã (N+1)**
7. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å Telegram rate limit handling**
8. ‚úÖ **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞**
9. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
10. ‚úÖ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å connection pool**

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–ª—É—á—à–µ–Ω–∏—è - —Å–¥–µ–ª–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–ø—Ä–∏–Ω—Ç–µ)

11. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã** (Prometheus/Grafana)
12. **–í–Ω–µ–¥—Ä–∏—Ç—å feature flags** –¥–ª—è A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
13. **–î–æ–±–∞–≤–∏—Ç—å queue system** (Bull/BullMQ) –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
14. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (Redis) –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
15. **Webhook mode** –≤–º–µ—Å—Ç–æ polling –¥–ª—è production

---

## üöÄ –ù–æ–≤—ã–µ —Ñ–∏—á–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

### 1. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// /start ref_USER_ID
// –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ —Ä–µ—Ñ–µ—Ä–µ—Ä—É
// –¢—Ä–µ–∫–∏–Ω–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö
```

**–¢–∞–±–ª–∏—Ü–∞ –ë–î:**
```sql
CREATE TABLE referrals (
  id SERIAL PRIMARY KEY,
  referrer_user_id BIGINT NOT NULL,
  referred_user_id BIGINT NOT NULL,
  bonus_granted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(referred_user_id)
);
```

---

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–£–≤–µ–¥–æ–º–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö:
- –°–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –≥—Ä—É–ø–ø–µ (access window)
- –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
class NotificationService {
  async notifyAccessExpiringSoon(userId: number, groupId: number, hoursLeft: number) {
    const message = `‚è∞ –í–Ω–∏–º–∞–Ω–∏–µ! –î–æ—Å—Ç—É–ø –∫ –≥—Ä—É–ø–ø–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ ${hoursLeft} —á–∞—Å–æ–≤`;
    await this.bot.sendMessage(userId, message);
  }
}
```

---

### 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ö–æ–º–∞–Ω–¥–∞:** `/mystats`

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ Montana
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –≥—Ä—É–ø–ø–µ
- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø
- –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

---

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –ë–î

**–û–ø–∏—Å–∞—Ü–∏—è:**
–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±—ç–∫–∞–ø—ã PostgreSQL –≤ S3/Google Drive

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```bash
#!/bin/bash
# scripts/backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="montana_backup_$DATE.sql.gz"

docker exec montana-postgres pg_dump -U montana montana_bot | gzip > "/backups/$BACKUP_FILE"

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ
rclone copy "/backups/$BACKUP_FILE" "gdrive:Montana/Backups/"

# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
find /backups -name "montana_backup_*.sql.gz" -mtime +30 -delete
```

---

### 5. Webhook –≤–º–µ—Å—Ç–æ Polling

**–ó–∞—á–µ–º:** –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API, –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–∫–ª–∏–∫

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
if (process.env.NODE_ENV === 'production') {
  await bot.setWebHook(`${WEBHOOK_URL}/webhook/${BOT_TOKEN}`);
} else {
  bot.startPolling();
}
```

---

### 6. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: Broadcast —Å–æ–æ–±—â–µ–Ω–∏—è

**–§—É–Ω–∫—Ü–∏—è:** –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–ª–∏ –≥—Ä—É–ø–ø–µ

**UI –≤ Dashboard:**
```html
<form>
  <textarea name="message">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</textarea>
  <select name="target">
    <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
    <option value="active">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
    <option value="group_123">–ì—Ä—É–ø–ø–∞ XYZ</option>
  </select>
  <button>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>
```

---

### 7. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
const variants = {
  A: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üëã',
  B: '–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å! üéâ'
};

const variant = userId % 2 === 0 ? 'A' : 'B';
await analytics.track('welcome_message_sent', { userId, variant });
```

---

### 8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ Telegram Payments –∏–ª–∏ Stripe

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–ø–ª–∞—Ç–µ
- –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

---

### 9. –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å (i18n)

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —è–∑—ã–∫–æ–≤ (RU/EN)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
import i18n from 'i18next';

await i18n.init({
  lng: user.language_code || 'ru',
  resources: {
    ru: { translation: require('./locales/ru.json') },
    en: { translation: require('./locales/en.json') }
  }
});

await bot.sendMessage(chatId, i18n.t('welcome_message'));
```

---

### 10. –ê–Ω—Ç–∏—Å–ø–∞–º —Å–∏—Å—Ç–µ–º–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ø–∞–º–µ—Ä–æ–≤

**–§–∏—á–∏:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É
- –î–µ—Ç–µ–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π
- –ê–≤—Ç–æ–±–∞–Ω –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

1. **Uptime –±–æ—Ç–∞** - % –≤—Ä–µ–º–µ–Ω–∏ online
2. **Latency –∫–æ–º–∞–Ω–¥** - –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
3. **Error rate** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫/—á–∞—Å
4. **Database query time** - –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
5. **Memory usage** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
6. **API rate limit hits** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 429 –æ—à–∏–±–æ–∫
7. **User growth** - –ø—Ä–∏—Ä–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
8. **CHURN rate** - –æ—Ç—Ç–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
9. **Join request approve rate** - % –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
10. **Message delivery rate** - % –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–µ–∫:

- **Prometheus** - —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫
- **Grafana** - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
- **AlertManager** - –∞–ª–µ—Ä—Ç—ã –≤ Telegram
- **Loki** - –ª–æ–≥–∏

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Checklist:

- [ ] Rate limiting –Ω–∞ –≤—Å–µ—Ö API endpoints
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤–≤–æ–¥–æ–≤
- [ ] –°–µ–∫—Ä–µ—Ç—ã –≤ vault (–Ω–µ –≤ .env —Ñ–∞–π–ª–µ)
- [ ] HTTPS –¥–ª—è webhook
- [ ] SQL injection –∑–∞—â–∏—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã ‚úÖ)
- [ ] XSS –∑–∞—â–∏—Ç–∞ –≤ dashboard
- [ ] CSRF —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ñ–æ—Ä–º
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- [ ] –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [ ] –û—Ç–∫–ª—é—á–µ–Ω–∏–µ stack traces –≤ production

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:
- Unit tests: ~40%
- Integration tests: ~10%

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –¥–æ 80%**
2. **–î–æ–±–∞–≤–∏—Ç—å E2E —Ç–µ—Å—Ç—ã** (Playwright –¥–ª—è dashboard)
3. **Load testing** (k6 –∏–ª–∏ Artillery)
4. **Security testing** (OWASP ZAP)
5. **CI/CD pipeline** (GitHub Actions):
   ```yaml
   name: Tests
   on: [push, pull_request]
   jobs:
     test:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v2
         - run: npm install
         - run: npm test
         - run: npm run lint
   ```

---

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **API Documentation** (OpenAPI/Swagger)
2. **Architecture Decision Records (ADR)**
3. **Deployment guide**
4. **Troubleshooting guide**
5. **Contributing guide**
6. **Changelog**

---

## üéì –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | ‚≠ê‚≠ê‚≠ê‚≠ê (4/5) | –•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –µ—Å—Ç—å –º–µ—Å—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è |
| –ö–æ–¥ –∫–∞—á–µ—Å—Ç–≤–æ | ‚≠ê‚≠ê‚≠ê (3/5) | –ï—Å—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω—É–∂–µ–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | ‚≠ê‚≠ê‚≠ê (3/5) | –ù–µ—Ç rate limiting, –µ—Å—Ç—å —Ä–∏—Å–∫–∏ |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | ‚≠ê‚≠ê‚≠ê (3/5) | N+1 queries, –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚≠ê‚≠ê (2/5) | –ù–∏–∑–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | ‚≠ê‚≠ê (2/5) | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | ‚≠ê (1/5) | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ‚≠ê‚≠ê‚≠ê (3/5) - **–•–æ—Ä–æ—à–∏–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, —Ç—Ä–µ–±—É—é—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏—è**

---

## üéØ Next Steps

1. **–ù–µ–¥–µ–ª—è 1:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
2. **–ù–µ–¥–µ–ª—è 2:** –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2)
3. **–ù–µ–¥–µ–ª—è 3:** –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ (2-3 –∏–∑ —Å–ø–∏—Å–∫–∞)
4. **–ù–µ–¥–µ–ª—è 4:** –£–ª—É—á—à–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

**–ö–æ–Ω–µ—Ü –æ—Ç—á—ë—Ç–∞**
